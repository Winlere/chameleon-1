<?xml version="1.0" encoding="UTF-8"?>
<jube>
    <benchmark name="bora" outpath="results">
        <comment>benchmark chameleon on host plafrim bora</comment>

        <parameterset name="param_gemm">
            <parameter name="hostname"           type="string">bora</parameter>
            <parameter name="algorithm"          type="string">gemm</parameter>
            <parameter name="precision"          type="string">s, d</parameter>
            <parameter name="i_pq"               type="int"   >0, 1, 2</parameter>
            <parameter name="p" mode="python"    type="int"   >[1, 2, 3][$i_pq]</parameter>
            <parameter name="q" mode="python"    type="int"   >[1, 2, 3][$i_pq]</parameter>
            <parameter name="nmpi" mode="python" type="int"   >[1, 4, 9][$i_pq]</parameter>
            <parameter name="nthr"               type="int"   >34</parameter>
            <parameter name="ngpu"               type="int"   >0</parameter>
            <parameter name="b"                  type="int"   >320</parameter>
            <parameter name="i_mn"               type="int"   >0, 1, 2, 3, 4</parameter>
            <parameter name="m" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
            <parameter name="k" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
            <parameter name="n" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
        </parameterset>

        <parameterset name="param_potrf">
            <parameter name="hostname"           type="string">bora</parameter>
            <parameter name="algorithm"          type="string">potrf</parameter>
            <parameter name="precision"          type="string">s, d</parameter>
            <parameter name="i_pq"               type="int"   >0, 1, 2</parameter>
            <parameter name="p" mode="python"    type="int"   >[1, 2, 3][$i_pq]</parameter>
            <parameter name="q" mode="python"    type="int"   >[1, 2, 3][$i_pq]</parameter>
            <parameter name="nmpi" mode="python" type="int"   >[1, 4, 9][$i_pq]</parameter>
            <parameter name="nthr"               type="int"   >34</parameter>
            <parameter name="ngpu"               type="int"   >0</parameter>
            <parameter name="b"                  type="int"   >320</parameter>
            <parameter name="i_mn"               type="int"   >0, 1, 2, 3, 4</parameter>
            <parameter name="m" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
            <parameter name="n" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
            <parameter name="k"                  type="int"   >1</parameter>
        </parameterset>

        <parameterset name="param_geqrf">
            <parameter name="hostname"           type="string">bora</parameter>
            <parameter name="algorithm"          type="string">geqrf_hqr</parameter>
            <parameter name="precision"          type="string">s, d</parameter>
            <parameter name="i_pq"               type="int"   >0, 1, 2</parameter>
            <parameter name="p" mode="python"    type="int"   >[1, 2, 3][$i_pq]</parameter>
            <parameter name="q" mode="python"    type="int"   >[1, 2, 3][$i_pq]</parameter>
            <parameter name="nmpi" mode="python" type="int"   >[1, 4, 9][$i_pq]</parameter>
            <parameter name="nthr"               type="int"   >34</parameter>
            <parameter name="ngpu"               type="int"   >0</parameter>
            <parameter name="b"                  type="int"   >320</parameter>
            <parameter name="i_mn"               type="int"   >0, 1, 2, 3, 4</parameter>
            <parameter name="m" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
            <parameter name="n" mode="python"    type="int"   >[${nmpi}*${b}, ${nmpi}*5*${b}, ${nmpi}*10*${b}, ${nmpi}*20*${b}, ${nmpi}*40*${b}][$i_mn]</parameter>
            <parameter name="k"                  type="int"   >1</parameter>
        </parameterset>

        <!-- Operation -->
        <step name="run_gemm" tag="gemm">
            <use>param_gemm</use>
            <do>mpiexec -np $nmpi $CHAMELEON_BUILD/new-testing/${precision}new-testing -o ${algorithm} -P $p -t $nthr -g $ngpu -m $m -n $n -k $k -b $b</do>
        </step>
        <step name="run_potrf" tag="potrf">
            <use>param_potrf</use>
            <do>mpiexec -np $nmpi $CHAMELEON_BUILD/new-testing/${precision}new-testing -o ${algorithm} -P $p -t $nthr -g $ngpu -m $m -n $n -k $k -b $b</do>
        </step>
        <step name="run_geqrf_hqr" tag="geqrf">
            <use>param_geqrf</use>
            <do>mpiexec -np $nmpi $CHAMELEON_BUILD/new-testing/${precision}new-testing -o ${algorithm} -P $p -t $nthr -g $ngpu -m $m -n $n -k $k -b $b</do>
        </step>

        <!-- Analyse -->
        <analyser name="analyse">
            <!-- use a pattern set -->
            <use from="../../jube/patterns.xml">chameleon</use>
            <analyse step="run_gemm" tag="gemm">
                <file>stdout</file> <!-- file which should be scanned -->
            </analyse>
            <analyse step="run_potrf" tag="potrf">
                <file>stdout</file> <!-- file which should be scanned -->
            </analyse>
            <analyse step="run_geqrf_hqr" tag="geqrf">
                <file>stdout</file> <!-- file which should be scanned -->
            </analyse>
        </analyser>


        <!-- Create result table -->
        <result>
            <use>analyse</use> <!-- use existing analyser -->
            <!--<table name="result" style="csv" sort="number">-->
            <table name="result" style="csv">
                <column>hostname</column>
                <column>algorithm</column>
                <column>precision</column>
                <column>nmpi</column>
                <column>p</column>
                <column>q</column>
                <column>nthr</column>
                <column>ngpu</column>
                <column>m</column>
                <column>n</column>
                <column>k</column>
                <column>cputime</column>
                <column>gflops</column>
            </table>
        </result>
    </benchmark>
</jube>
