---
sonarqube:
  stage: analyse
  extends:
    - .only-master
  needs: [test_openmp_shm_c,test_openmp_shm_d,test_openmp_shm_s,test_openmp_shm_z,
          test_parsec_shm_c,test_parsec_shm_d,test_parsec_shm_s,test_parsec_shm_z,
          test_quark_shm_c,test_quark_shm_d,test_quark_shm_s,test_quark_shm_z,
          test_starpu_shm_c,test_starpu_shm_d,test_starpu_shm_s,test_starpu_shm_z,
          test_starpu_mpi_c,test_starpu_mpi_d,test_starpu_mpi_s,test_starpu_mpi_z,
          test_starpu_simgrid_simu_all]
  dependencies: [test_openmp_shm_c,test_openmp_shm_d,test_openmp_shm_s,test_openmp_shm_z,
                 test_parsec_shm_c,test_parsec_shm_d,test_parsec_shm_s,test_parsec_shm_z,
                 test_quark_shm_c,test_quark_shm_d,test_quark_shm_s,test_quark_shm_z,
                 test_starpu_shm_c,test_starpu_shm_d,test_starpu_shm_s,test_starpu_shm_z,
                 test_starpu_mpi_c,test_starpu_mpi_d,test_starpu_mpi_s,test_starpu_mpi_z,
                 test_starpu_simgrid_simu_all]
  variables:
    VERSION: sonarqube
  script:
    - cat *.log > chameleon_build.log
    - ./tools/analysis.sh
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    expire_in: 2 days
    when: always
    paths:
      - coverage.xml
      - chameleon_coverage.xml
      - chameleon_cppcheck.xml
      - sonar.log
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
