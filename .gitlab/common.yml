#
# This file describes the common rules for the stages
#
---
default:
  image: registry.gitlab.inria.fr/solverstack/docker/distrib
  tags: ['ci.inria.fr', 'linux', 'large']

.only-master:
  except: ['schedule']
  interruptible: true
  only:
    - master@solverstack/chameleon
    - /^ci-.*$/
  except:
    - /^notest-.*$/

.only-branches:
  except: ['schedule']
  interruptible: true
  only:
    - merge_requests
    - master@solverstack/chameleon
    - /^ci-.*$/
  except:
    - /^notest-.*$/

.build_script_template:
  stage: build
  extends: .only-branches
  script:
    - ./.gitlab/build.sh
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    expire_in: 2 days
    untracked: true
    when: always

.test_script_template:
  stage: test
  script:
    - ./.gitlab/test.sh
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    expire_in: 2 days
    untracked: true
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: junit.xml

.bench_plafrim_common:
  only: ['schedule']
  stage: test
  tags: ['plafrim']
  timeout: 1 week
  before_script:
    - git submodule update --init --recursive
  script:
    - ./tools/bench/plafrim/run.sh
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    expire_in: 1 week
    paths:
      - "chameleon-$NODE-$MPI-$SLURM_NP.err"
      - "chameleon-$NODE-$MPI-$SLURM_NP.out"
      - "tools/bench/plafrim/chameleon.csv"
      - "tools/bench/plafrim/results/$JUBE_ID"
  variables:
    PLATFORM: plafrim
